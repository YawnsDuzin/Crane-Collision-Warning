# Crane-Collision-Warning

건설현장 타워크레인 간 충돌을 실시간으로 예측하고 경고하는 시스템

---

## 시스템 개요

대형 건설현장에서 여러 대의 타워크레인이 동시에 운용될 때, 붐대(팔)의 작업 반경이 겹치는 구간에서 충돌 위험이 발생합니다. 이 시스템은 각 크레인의 위치와 움직임을 실시간으로 분석하여 충돌 가능성을 사전에 예측하고 운전자와 관제실에 경고합니다.

### 주요 기능

- **실시간 3D 모니터링**: 모든 크레인의 위치와 자세를 3D로 시각화
- **충돌 예측**: 현재 속도 기반으로 최대 30초 후까지 충돌 가능성 예측
- **4단계 경보**: 정상 → 주의 → 경고 → 위험 등급 자동 판정
- **시뮬레이션**: 실제 크레인 없이 다양한 시나리오로 사전 테스트
- **웹 기반 관제**: 브라우저에서 접속하여 어디서든 모니터링

---

## 빠른 시작

### 1. 필요 환경

- Python 3.9 이상
- pip (Python 패키지 관리자)

### 2. 설치

```bash
# 저장소 클론
git clone https://github.com/YawnsDuzin/Crane-Collision-Warning.git
cd Crane-Collision-Warning

# 가상환경 생성 (권장)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# 패키지 설치
pip install -r requirements.txt
```

### 3. 실행

```bash
python run.py
```

### 4. 접속

웹 브라우저에서 **http://localhost:8000** 접속

---

## 프로젝트 구조

```
Crane-Collision-Warning/
│
├── run.py                    # 실행 스크립트 (이것만 실행하면 됨)
├── requirements.txt          # 필요 패키지 목록
│
├── config/                   # 설정
│   └── settings.py           # 전체 설정값 (안전 거리, 크레인 정보 등)
│
├── core/                     # 핵심 엔진 (시스템의 두뇌)
│   ├── geometry.py           # 3D 좌표 계산 (붐대 끝점 위치 등)
│   ├── crane.py              # 크레인 모델 (위치, 각도, 속도)
│   ├── collision.py          # 충돌 예측 엔진 (거리 측정, 미래 예측)
│   └── alert.py              # 경보 시스템 (경고 메시지 생성)
│
├── simulator/                # 시뮬레이션 (가상 테스트)
│   ├── engine.py             # 시뮬레이션 엔진
│   └── scenarios.py          # 사전 정의 시나리오 5종
│
├── server/                   # 웹 서버
│   ├── app.py                # FastAPI 메인 앱
│   ├── routes.py             # REST API (크레인 제어, 시나리오 등)
│   └── websocket.py          # WebSocket 실시간 통신
│
├── templates/                # HTML 템플릿
│   └── index.html            # 메인 관제 화면
│
├── static/                   # 정적 파일 (브라우저용)
│   ├── css/style.css         # 스타일시트
│   └── js/
│       ├── main.js           # 메인 UI 로직
│       ├── three-scene.js    # Three.js 3D 시각화
│       └── websocket-client.js  # WebSocket 클라이언트
│
└── tests/                    # 테스트
    ├── test_geometry.py      # 기하학 계산 테스트
    ├── test_collision.py     # 충돌 예측 테스트
    └── test_simulation.py    # 시뮬레이션 테스트
```

---

## 핵심 로직 설명

### 1. 크레인 위치 계산 (geometry.py)

타워크레인의 붐대 끝점 위치를 3D 좌표로 계산합니다.

```
        붐대 끝점 (이것을 계산!)
           ●
          ╱
         ╱  붐대 길이
        ╱
       ╱ ← 기복각
      ╱
마스트 꼭대기 ●
      │
      │  마스트 높이
      │
──────●────── 지면
    기초 위치
```

**계산 공식:**
```
X = 기초X + 붐대길이 × cos(기복각) × sin(선회각)
Y = 기초Y + 붐대길이 × cos(기복각) × cos(선회각)
Z = 마스트높이 + 붐대길이 × sin(기복각)
```

### 2. 충돌 판단 (collision.py)

세 단계로 충돌 위험을 판단합니다:

1. **빠른 필터**: 작업 반경이 겹치는지 확인 (원 겹침 판정)
2. **거리 측정**: 붐대 선분 간 최소 거리 계산
3. **미래 예측**: 현재 속도를 유지할 때 미래 궤적에서 최소 접근 거리 계산

### 3. 위험 등급 판정

| 등급 | 거리 기준 | 시간 기준 | 동작 |
|------|-----------|-----------|------|
| **정상** | > 10m | 충돌 예상 없음 | 정상 운행 |
| **주의** | 5~10m | 30초 내 접근 | 운전자 알림 |
| **경고** | 3~5m | 10초 내 접근 | 음성 경고, 속도 제한 |
| **위험** | < 3m | 5초 내 충돌 | 비상 정지, 관제실 알림 |

---

## 시뮬레이션 시나리오

웹 화면 우측의 시나리오 패널에서 다음 시나리오를 선택할 수 있습니다:

| 시나리오 | 설명 |
|----------|------|
| **정상 운행** | 3대가 안전하게 작업 중 |
| **접근 상황** | 2대가 서로 접근하여 위험도 상승 |
| **정면 충돌 코스** | 2대가 서로를 마주보고 있음 (즉시 위험) |
| **교차 통과** | 2대의 붐대가 같은 영역을 통과 |
| **다중 크레인 혼잡** | 4대가 좁은 구역에서 동시 작업 |

---

## API 문서

서버 실행 후 **http://localhost:8000/docs** 에서 자동 생성된 API 문서를 확인할 수 있습니다.

### 주요 API

```
GET  /api/cranes              # 모든 크레인 상태 조회
GET  /api/cranes/{id}         # 특정 크레인 상태 조회
POST /api/cranes/{id}/control # 크레인 제어 (속도 변경 등)
GET  /api/status              # 전체 시스템 상태
GET  /api/collisions          # 충돌 검사 결과
GET  /api/scenarios           # 시나리오 목록
POST /api/scenarios/apply     # 시나리오 적용
WS   /ws                      # WebSocket 실시간 데이터
```

---

## 테스트

```bash
# 전체 테스트 실행
python -m pytest tests/ -v

# 특정 모듈 테스트
python -m pytest tests/test_geometry.py -v
python -m pytest tests/test_collision.py -v
python -m pytest tests/test_simulation.py -v
```

---

## 개발 단계 로드맵

### 1단계: 시뮬레이션 (현재) ✅
- [x] 충돌 예측 알고리즘
- [x] 웹 기반 시뮬레이터
- [x] 3D 시각화
- [x] 시나리오 테스트

### 2단계: 단일 크레인 연동
- [ ] 센서 데이터 수집 모듈 (엔코더, GPS)
- [ ] 엣지 장치(오렌지파이) 연동
- [ ] 실제 크레인 데이터로 좌표 계산 검증

### 3단계: 다중 크레인 통합
- [ ] 2대 이상 크레인 동시 모니터링
- [ ] 운전실 경보 단말 개발
- [ ] 이벤트 기록 및 리포트

### 4단계: 고도화
- [ ] 영상 기반 보조 시스템
- [ ] 자동 제어 연동 (속도 제한, 비상 정지)
- [ ] AI 기반 작업 패턴 분석

---

## 기술 스택

| 구분 | 기술 | 역할 |
|------|------|------|
| 백엔드 | FastAPI (Python) | 웹 서버, API |
| 프론트엔드 | HTML/CSS/JS | 관제 화면 |
| 3D 시각화 | Three.js | 웹 기반 3D 표시 |
| 실시간 통신 | WebSocket | 서버 ↔ 브라우저 |
| 수학 연산 | NumPy | 좌표 및 벡터 계산 |
| 테스트 | pytest | 단위/통합 테스트 |

---

## 현장 적용 시 필요 하드웨어

| 항목 | 용도 | 비고 |
|------|------|------|
| 엣지 장치 (크레인당) | 센서 데이터 수집 | 오렌지파이5 / 라즈베리파이 |
| 선회각 센서 | 붐대 방향 측정 | 로터리 엔코더 / IMU |
| 기복각 센서 | 붐대 올림각 측정 | 경사계 |
| RTK-GPS | 크레인 위치 측정 | 오차 2cm 이내 |
| 4G 모뎀 | 데이터 전송 | 각 크레인 → 서버 |
| 관제실 모니터 | 현황 표시 | 대형 디스플레이 |
