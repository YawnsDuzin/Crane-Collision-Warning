# 좌표 계산 - 붐대 끝점 위치 구하기

> 이 문서는 `core/geometry.py`의 `calculate_boom_tip_position()` 함수를 설명합니다.
> 삼각함수(sin, cos) 개념은 `03_수학기초_삼각함수.md`를 먼저 읽어주세요.

---

## 이 계산이 하는 일

크레인의 **기초 위치, 마스트 높이, 붐대 길이, 선회각, 기복각** 5가지 정보를 입력하면, **붐대 끝점의 3D 좌표 (X, Y, Z)**를 출력합니다.

```
[입력]                              [출력]
기초 위치 (base_x, base_y)    →
마스트 높이 (mast_height)     →    붐대 끝점
붐대 길이 (boom_length)       →    (X, Y, Z)
선회각 (slew_angle)           →
기복각 (luffing_angle)        →
```

---

## 전체 계산 과정 (3단계)

### 전체 그림

```
           [3D 붐대 끝점 위치]
                  │
     ┌────────────┼────────────┐
     │            │            │
  1단계        2단계        3단계
수평거리 계산  X,Y좌표 계산  Z좌표 계산
(기복각 사용)  (선회각 사용)  (기복각 사용)
     │            │            │
     ▼            ▼            ▼
 horizontal    tip_x        tip_z
 _reach        tip_y
```

---

## 1단계: 수평 도달 거리 계산

**질문**: 붐대가 기울어져 있을 때, 지면에서 수평으로 얼마나 멀리 닿는가?

```
옆에서 본 모습:

             ● 붐대 끝점
            ╱│
           ╱ │
 붐대길이 ╱  │ (높이 변화)
         ╱   │
        ╱ θ  │  ← θ = 기복각
       ●─────┘
       │← 수평거리 →│
       │
       │ 마스트
       │
```

**공식**:
```
수평 거리 = 붐대 길이 × cos(기복각)
```

**코드** (`core/geometry.py` 103번줄):
```python
horizontal_reach = boom_length * math.cos(luff_rad)
```

### 숫자 예시

| 붐대 길이 | 기복각 | cos(기복각) | 수평 거리 | 해석 |
|-----------|--------|------------|-----------|------|
| 60m | 0도 | 1.000 | 60.0m | 완전 수평 → 최대 도달 |
| 60m | 10도 | 0.985 | 59.1m | 약간 올림 → 거의 최대 |
| 60m | 15도 | 0.966 | 57.9m | 기본 설정 |
| 60m | 30도 | 0.866 | 52.0m | 적당히 올림 |
| 60m | 45도 | 0.707 | 42.4m | 대각선 |
| 60m | 60도 | 0.500 | 30.0m | 많이 올림 → 반만 도달 |

---

## 2단계: X, Y 좌표 계산 (수평 방향 결정)

**질문**: 수평 거리를 알았으니, 이것이 동서남북 어느 방향인가?

```
위에서 내려다본 모습:

           Y (북)
           │
           │       ● (X, Y)
           │      ╱
           │     ╱
           │    ╱ 수평거리
           │   ╱
           │  ╱
           │ ╱ θ ← 선회각
           │╱
    ───────●─────────── X (동)
         기초(0,0)
```

1단계에서 구한 수평 거리를 X(동쪽)과 Y(북쪽)으로 **분배**합니다.

**공식**:
```
X = 기초X + 수평거리 × sin(선회각)
Y = 기초Y + 수평거리 × cos(선회각)
```

**코드** (`core/geometry.py` 107-108번줄):
```python
tip_x = base_x + horizontal_reach * math.sin(slew_rad)
tip_y = base_y + horizontal_reach * math.cos(slew_rad)
```

### 선회각별 방향 확인

수평 거리 = 52m라고 가정했을 때:

| 선회각 | 방향 | sin값 | cos값 | X (동쪽) | Y (북쪽) | 해석 |
|--------|------|-------|-------|---------|---------|------|
| 0도 | 북 | 0.0 | 1.0 | 0m | 52m | 정북쪽으로 52m |
| 45도 | 북동 | 0.707 | 0.707 | 36.8m | 36.8m | 대각선 북동쪽 |
| 90도 | 동 | 1.0 | 0.0 | 52m | 0m | 정동쪽으로 52m |
| 135도 | 남동 | 0.707 | -0.707 | 36.8m | -36.8m | 대각선 남동쪽 |
| 180도 | 남 | 0.0 | -1.0 | 0m | -52m | 정남쪽으로 52m |
| 270도 | 서 | -1.0 | 0.0 | -52m | 0m | 정서쪽으로 52m |

---

## 3단계: Z 좌표 계산 (높이)

**질문**: 붐대 끝점의 높이는?

```
옆에서 본 모습:

                              ● 붐대 끝점 (Z = tip_z)
                             ╱│
                            ╱ │
              붐대 길이     ╱  │ 높이 증가
                          ╱   │ = 붐대길이 × sin(기복각)
                         ╱ θ  │
    Z = mast_height → ●──────┘
                      │
                      │ 마스트 높이
                      │
                ──────┘
               Z = 0 (지면)
```

**공식**:
```
Z = 마스트 높이 + 붐대 길이 × sin(기복각)
```

**코드** (`core/geometry.py` 111번줄):
```python
tip_z = mast_height + boom_length * math.sin(luff_rad)
```

### 숫자 예시 (마스트 높이 = 40m, 붐대 길이 = 60m)

| 기복각 | sin값 | 높이 증가 | 최종 높이(Z) | 해석 |
|--------|-------|-----------|-------------|------|
| 0도 | 0.000 | 0m | 40m | 마스트 높이와 같음 |
| 10도 | 0.174 | 10.4m | 50.4m | 약간 올라감 |
| 15도 | 0.259 | 15.5m | 55.5m | 기본 설정 |
| 30도 | 0.500 | 30.0m | 70.0m | 꽤 높음 |
| 45도 | 0.707 | 42.4m | 82.4m | 상당히 높음 |
| 60도 | 0.866 | 52.0m | 92.0m | 매우 높음 |

---

## 완전한 계산 예시: 1호기 (TC-1)

### 조건 (config/settings.py의 기본값)

```
크레인 ID: TC-1 (1호기)
기초 위치: (0, 0)
마스트 높이: 40m
붐대 길이: 60m
선회각: 45도 (북동쪽 방향)
기복각: 15도
```

### 계산 과정

**1단계: 수평 거리**
```
수평 거리 = 60 × cos(15도)
         = 60 × 0.9659
         = 57.96m
```

**2단계: X 좌표 (동쪽 방향)**
```
X = 0 + 57.96 × sin(45도)
  = 0 + 57.96 × 0.7071
  = 40.98m
```

**3단계: Y 좌표 (북쪽 방향)**
```
Y = 0 + 57.96 × cos(45도)
  = 0 + 57.96 × 0.7071
  = 40.98m
```

**4단계: Z 좌표 (높이)**
```
Z = 40 + 60 × sin(15도)
  = 40 + 60 × 0.2588
  = 40 + 15.53
  = 55.53m
```

### 최종 결과

```
1호기 붐대 끝점 = (40.98, 40.98, 55.53)
```

**해석**: "기준점에서 동쪽 약 41m, 북쪽 약 41m, 높이 약 56m 위치에 1호기 붐대 끝이 있다"

```
위에서 본 모습:                옆에서 본 모습:

    Y(북)                      높이(m)
    │                          70 ┤
 41 ┤·····● (41, 41)           56 ┤·····● 끝점
    │    ╱                        │   ╱
    │   ╱                      40 ┤──●
    │  ╱                          │  │ 마스트
    │ ╱                           │  │
    │╱                          0 ┤──┘ 지면
 ───●──── X(동)                ───┘
  (0,0)  41
```

---

## 완전한 계산 예시: 2호기 (TC-2)

### 조건

```
크레인 ID: TC-2 (2호기)
기초 위치: (80, 0)      ← 1호기에서 동쪽으로 80m
마스트 높이: 45m
붐대 길이: 55m
선회각: 200도 (남남서 방향)
기복각: 10도
```

### 계산 과정

**1단계: 수평 거리**
```
수평 거리 = 55 × cos(10도) = 55 × 0.9848 = 54.16m
```

**2단계: X 좌표**
```
X = 80 + 54.16 × sin(200도) = 80 + 54.16 × (-0.3420) = 80 + (-18.52) = 61.48m
```

> **참고**: sin(200도)은 **음수**입니다. 200도는 남쪽+서쪽 방향이니까 X가 줄어드는 게 맞습니다.

**3단계: Y 좌표**
```
Y = 0 + 54.16 × cos(200도) = 0 + 54.16 × (-0.9397) = -50.89m
```

> cos(200도)도 음수입니다. 남쪽 방향이니까 Y가 줄어드는 게 맞습니다.

**4단계: Z 좌표**
```
Z = 45 + 55 × sin(10도) = 45 + 55 × 0.1736 = 45 + 9.55 = 54.55m
```

### 최종 결과

```
2호기 붐대 끝점 = (61.48, -50.89, 54.55)
```

**해석**: "기준점에서 동쪽 약 61m, 남쪽 약 51m, 높이 약 55m에 2호기 붐대 끝이 있다"

---

## 기초 위치가 원점이 아닌 경우

기초 위치가 (80, 0)처럼 원점이 아닌 경우에도 공식은 **동일**합니다.

핵심은 공식에서 `기초X +`, `기초Y +`가 있다는 점입니다.

```
X = "기초X" + 수평거리 × sin(선회각)
     ↑
     이 부분이 크레인 기초 위치를 반영
```

크레인이 어디에 세워져 있든, 붐대의 "상대적 위치"를 계산한 뒤 기초 위치를 더해주면 됩니다.

---

## 작업 반경 계산

현재 작업 반경은 수평 거리와 같습니다.

```
작업 반경 = 붐대 길이 × cos(기복각)
```

**코드** (`core/crane.py`의 `get_working_radius()` 메서드):
```python
def get_working_radius(self) -> float:
    return self.boom_length * math.cos(math.radians(self.luffing_angle))
```

**최대** 작업 반경은 기복각이 0도일 때 = 붐대 길이 자체:
```python
def get_max_working_radius(self) -> float:
    return self.boom_length  # cos(0) = 1이므로
```

---

## 코드와 수식 대응표

| 수식 | 코드 (geometry.py) | 설명 |
|------|-------|------|
| `수평거리 = L × cos(θ_luff)` | `horizontal_reach = boom_length * math.cos(luff_rad)` | 수평 도달거리 |
| `X = Bx + 수평거리 × sin(θ_slew)` | `tip_x = base_x + horizontal_reach * math.sin(slew_rad)` | 동서 위치 |
| `Y = By + 수평거리 × cos(θ_slew)` | `tip_y = base_y + horizontal_reach * math.cos(slew_rad)` | 남북 위치 |
| `Z = H + L × sin(θ_luff)` | `tip_z = mast_height + boom_length * math.sin(luff_rad)` | 높이 |

- `L` = boom_length (붐대 길이)
- `H` = mast_height (마스트 높이)
- `Bx, By` = base_x, base_y (기초 위치)
- `θ_slew` = slew_angle (선회각)
- `θ_luff` = luffing_angle (기복각)
