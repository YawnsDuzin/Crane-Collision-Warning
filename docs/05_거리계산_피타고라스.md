# 거리 계산 - 피타고라스 정리와 원 겹침

> 이 문서는 두 지점 사이의 거리를 구하는 방법과, 두 크레인의 작업 반경이 겹치는지 판별하는 방법을 설명합니다.
> `core/geometry.py`의 `calculate_distance_3d`, `calculate_distance_2d`, `check_working_radius_overlap` 함수에 해당합니다.

---

## 왜 거리 계산이 필요한가?

두 크레인의 붐대 끝점이 **얼마나 가까운지** 알아야 충돌 위험을 판단할 수 있습니다.

```
1호기 붐대 끝점 ●                    ● 2호기 붐대 끝점
                 ←──── ? m ────→
                "이 거리가 몇 m인가?"
```

---

## 피타고라스 정리 복습

### 2D (평면) 거리

두 점 사이의 거리는 **피타고라스 정리**로 구합니다.

```
점A (x1, y1)와 점B (x2, y2) 사이의 거리:

       B (x2, y2)
       │╲
       │  ╲  거리 = ?
  세로 │    ╲
  차이 │      ╲
       │________╲
       C        A (x1, y1)
       ← 가로 차이 →
```

**공식**:
```
가로 차이 = x1 - x2
세로 차이 = y1 - y2

거리 = √(가로 차이² + 세로 차이²)
```

### 숫자 예시

점A = (0, 0), 점B = (3, 4) 사이의 거리:

```
가로 차이 = 3 - 0 = 3
세로 차이 = 4 - 0 = 4

거리 = √(3² + 4²)
     = √(9 + 16)
     = √25
     = 5
```

```
     Y
  4  ┤·······B(3,4)
     │      ╱│
     │     ╱ │
     │  5 ╱  │ 4
     │   ╱   │
     │  ╱    │
  0  A───────┘
     0   3   X
```

> **핵심**: 가로 3, 세로 4의 대각선 = 5. 이것이 피타고라스 정리입니다.

**코드** (`core/geometry.py:155-157`):
```python
def calculate_distance_2d(x1, y1, x2, y2):
    dx = x1 - x2
    dy = y1 - y2
    return math.sqrt(dx * dx + dy * dy)
```

---

## 3D 거리 계산

3D에서는 **높이 차이**도 추가됩니다.

```
거리 = √(가로 차이² + 세로 차이² + 높이 차이²)
```

이것은 피타고라스 정리를 **한 번 더** 적용한 것입니다.

### 단계별 이해

```
1단계: 먼저 바닥(2D)에서 거리를 구함
    바닥 거리 = √(dx² + dy²)

2단계: 바닥 거리와 높이 차이로 최종 3D 거리를 구함
    3D 거리 = √(바닥 거리² + 높이 차이²)
            = √(dx² + dy² + dz²)    ← 결과적으로 이렇게 됨
```

```
   B (위에 있는 점)
   │ ╲
   │   ╲  3D 거리
dz │     ╲
   │       ╲
   └─────── A' (B를 바닥에 내린 점)
        ╱
      ╱  바닥거리 = √(dx² + dy²)
    ╱
   A (바닥에 있는 점)
```

### 숫자 예시

1호기 끝점 A = (41, 41, 56), 2호기 끝점 B = (61, -51, 55) 사이의 거리:

```
dx = 41 - 61 = -20     (가로 차이 20m)
dy = 41 - (-51) = 92   (세로 차이 92m)
dz = 56 - 55 = 1       (높이 차이 1m)

거리 = √((-20)² + 92² + 1²)
     = √(400 + 8464 + 1)
     = √8865
     = 94.16m
```

**해석**: 두 크레인의 붐대 끝점은 약 94m 떨어져 있다 → **안전**

**코드** (`core/geometry.py:135-138`):
```python
def calculate_distance_3d(point1, point2):
    dx = point1[0] - point2[0]
    dy = point1[1] - point2[1]
    dz = point1[2] - point2[2]
    return math.sqrt(dx * dx + dy * dy + dz * dz)
```

> **참고**: `dx * dx`는 `dx²`과 같은 뜻입니다. Python에서 제곱은 `**2`로도 쓸 수 있지만, 곱셈이 더 빠릅니다.

---

## 제곱근(√)이란?

제곱근(루트)은 **"어떤 수를 두 번 곱하면 이 값이 되는 수"**를 구하는 것입니다.

```
√25 = 5    (왜냐하면 5 × 5 = 25)
√100 = 10  (왜냐하면 10 × 10 = 100)
√2 ≈ 1.414 (왜냐하면 1.414 × 1.414 ≈ 2)
```

코드에서는 `math.sqrt()` 함수가 자동으로 계산합니다.

---

## 작업 반경 겹침 판별

### 원리

각 크레인의 작업 반경을 위에서 보면 **원**입니다. 두 원이 겹치는지 확인하는 방법은 간단합니다.

```
규칙: 두 원의 중심 사이 거리 < 두 반지름의 합  →  겹침!
```

### 그림으로 이해

**겹치지 않는 경우**:
```
중심 거리 = 200m
반지름 합 = 60 + 60 = 120m
200 > 120 → 겹치지 않음 ✓

  ╭───╮         ╭───╮
 │ A  │         │ B  │
 │ 60m│         │60m │
  ╰───╯         ╰───╯
  ←──── 200m ────→
```

**겹치는 경우**:
```
중심 거리 = 80m
반지름 합 = 60 + 60 = 120m
80 < 120 → 겹침! ✓

  ╭───╮     ╭───╮
 │ A ████████ B  │
 │ 60m█겹침█60m │
  ╰───╯     ╰───╯
  ←── 80m ──→
```

**경계선 경우**:
```
중심 거리 = 120m
반지름 합 = 60 + 60 = 120m
120 = 120 → 코드에서는 "겹치지 않음"으로 판정 (strict less than)
```

### 숫자 예시

**1호기와 2호기**:
```
1호기: 기초 (0, 0), 최대 반경 60m
2호기: 기초 (80, 0), 최대 반경 55m

중심 거리 = √((80-0)² + (0-0)²) = √6400 = 80m
반지름 합 = 60 + 55 = 115m

80 < 115 → 겹침! → 충돌 가능성 있음
```

**1호기와 3호기**:
```
1호기: 기초 (0, 0), 최대 반경 60m
3호기: 기초 (40, 70), 최대 반경 50m

중심 거리 = √((40-0)² + (70-0)²) = √(1600 + 4900) = √6500 = 80.62m
반지름 합 = 60 + 50 = 110m

80.62 < 110 → 겹침! → 충돌 가능성 있음
```

**코드** (`core/geometry.py:188-190`):
```python
def check_working_radius_overlap(base_x1, base_y1, radius1,
                                  base_x2, base_y2, radius2):
    center_distance = calculate_distance_2d(base_x1, base_y1, base_x2, base_y2)
    return center_distance < (radius1 + radius2)
```

### 왜 이 검사를 먼저 하나?

이 검사가 **"빠른 필터"** 역할을 합니다.

```
작업 반경이 안 겹침 → 물리적으로 충돌 불가능 → 더 계산할 필요 없음!
작업 반경이 겹침    → 충돌 가능성 있음 → 상세 계산 진행
```

작업 반경 겹침 검사는 계산이 간단해서 빠르고, 겹치지 않는 경우를 즉시 걸러낼 수 있습니다.
상세 계산(선분 간 거리, 미래 예측)은 복잡하니까 필요한 경우에만 수행합니다.

---

## 거리 기준 경보 등급

계산된 거리를 기준으로 위험 등급을 판정합니다.

```
거리 계산 결과
     │
     ▼
  ≤ 3m  → [위험] 즉시 정지!
  ≤ 5m  → [경고] 속도 줄일 것
  ≤ 10m → [주의] 주의 필요
  > 10m → [정상] 안전
```

| 거리 범위 | 등급 | 조치 |
|-----------|------|------|
| 0 ~ 3m | 위험 (DANGER) | 비상 정지 |
| 3 ~ 5m | 경고 (WARNING) | 속도 제한 |
| 5 ~ 10m | 주의 (CAUTION) | 운전자 알림 |
| 10m 이상 | 정상 (NORMAL) | 정상 운행 |
